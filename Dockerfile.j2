FROM vikingco/python:{{ pythonversion }}
MAINTAINER technology@vikingco.com

#############################
# Set environment variables #
#############################
ENV CONF_SRC=./conf \
    CONF_DIR=${ROOT}/conf \
    MEDIA_DIR=${ROOT}/media \
    STATIC_DIR=${ROOT}/static \
    RUN_DIR=${ROOT}/run \
    MANAGE_FILE=manage.py \
    DJANGO_ROOT=${SRC_DIR} \
    WSGI_FILE=wsgi.py \
    PYTHON_PATH=${SRC_DIR}:${PYENV_ROOT}/versions/${PYENV_VERSION}/bin

########################
# Configure build args #
########################
ARG PORT=8000
ARG UWSGI_PORT=3031
ARG STATUS_PORT=9191

##############################
# Copy deployment into image #
##############################
COPY ${DEPLOYMENT_SRC} ${DEPLOYMENT_DIR}

#####################################
# Install packages and requirements #
#####################################
RUN set -x \
    && buildPackages=`cat ${DEPLOYMENT_DIR}/${REQUIRED_BUILD_PACKAGES_FILE}` \
    && runtimePackages=`cat ${DEPLOYMENT_DIR}/${REQUIRED_RUNTIME_PACKAGES_FILE}` \
    && sudo yum install -y ${runtimePackages} ${buildPackages} \
    && pip install -r ${DEPLOYMENT_DIR}/${PYTHON_REQUIREMENTS_FILE} \
    && find /usr/local \
		\( -type d -a -name test -o -name tests \) \
		-o \( -type f -a -name '*.pyc' -o -name '*.pyo' \) \
		-exec rm -rf '{}' + \
    && sudo rm -rf /tmp/* \
    && sudo yum remove -y ${buildPackages} \
    && sudo yum clean all

####################
# Make directories #
####################
RUN mkdir -p ${MEDIA_DIR} && \
    mkdir -p ${STATIC_DIR} && \
    mkdir -p ${RUN_DIR}

#################
# Copy in files #
#################
COPY ${CONF_SRC} ${CONF_DIR}
COPY ${SCRIPTS_SRC} ${SCRIPTS_DIR}

################
# Expose ports #
################
EXPOSE ${PORT} ${STATUS_PORT} ${UWSGI_PORT}

###############
# Set workdir #
###############
WORKDIR ${DJANGO_ROOT}
